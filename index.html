<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è¸©åœ°é›· Minesweeper â€” å–®æª”ç‰ˆ</title>
<style>
  :root{
    --bg:#0f172a;           /* slate-900 */
    --panel:#111827;        /* gray-900  */
    --tile:#1f2937;         /* gray-800  */
    --tile-hi:#374151;      /* gray-700  */
    --grid:#0b1220;
    --accent:#22d3ee;       /* cyan-400  */
    --accent-2:#38bdf8;     /* sky-400   */
    --danger:#ef4444;
    --ok:#10b981;
    --text:#e5e7eb;         /* gray-200  */
    --muted:#9ca3af;        /* gray-400  */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1000px 600px at 10% 0%,#0b1220 0%,#0a0f1e 45%,#0a0e1a 60%,#080b13 100%),
      linear-gradient(180deg,#0b1120 0%,#0b1220 100%);
    color:var(--text); font-family: ui-sans-serif, system-ui, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .app{
    width:min(1100px,95vw); display:grid; gap:12px;
    grid-template-columns: 1fr;
  }
  .topbar, .toolbar, .status{
    background:linear-gradient(180deg,#0f172a,#0b1220);
    border:1px solid #22304d; border-radius:12px; padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
  }
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
  h1{font-size:18px; margin:0; letter-spacing:.5px; color:#c7d2fe}
  .brand{display:flex; align-items:center; gap:10px}
  .chip{font-size:12px; color:#0a0f1e; background:linear-gradient(90deg,var(--accent),var(--accent-2));
        padding:4px 8px; border-radius:999px; font-weight:700}
  .toolbar{display:grid; gap:10px; grid-template-columns: repeat(12,1fr); align-items:end}
  .group{display:flex; flex-direction:column; gap:6px}
  .group label{font-size:12px; color:var(--muted)}
  select,input[type="number"]{
    background:var(--tile); color:var(--text); border:1px solid #243045; border-radius:10px;
    padding:8px 10px; outline:none; width:100%;
  }
  .row{grid-column: span 3}
  .row.wide{grid-column: span 6}
  .row.full{grid-column: 1 / -1}
  .ctrls{display:flex; gap:10px; flex-wrap:wrap}
  button{
    background:linear-gradient(180deg,#1f2937,#0f172a);
    color:var(--text); border:1px solid #2a3a57; border-radius:10px; padding:10px 14px;
    cursor:pointer; font-weight:600;
  }
  button:hover{filter:brightness(1.08)}
  button.primary{
    border-color:transparent;
    background:linear-gradient(90deg,var(--accent-2),var(--accent));
    color:#06101a;
  }
  button.danger{
    background:linear-gradient(180deg,#2a1b1b,#1b0f10);
    border-color:#5b1d1d; color:#ffd7d7;
  }
  .status{display:flex; justify-content:space-between; align-items:center; gap:12px}
  .stat{display:flex; align-items:center; gap:8px; font-variant-numeric:tabular-nums}
  .stat .val{font-weight:800; letter-spacing:.5px}
  .grid-wrap{
    background:linear-gradient(180deg,#0f172a,#091223);
    border:1px solid #22304d; border-radius:12px; padding:12px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
  }
  #board{
    display:grid; gap:6px; width:100%;
  }
  .cell{
    user-select:none; -webkit-user-select:none; touch-action:manipulation;
    width:32px; height:32px; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,var(--tile),#151b26);
    border:1px solid #2a3a57; border-radius:6px; font-weight:800; cursor:pointer;
    box-shadow: 0 1px 0 rgba(255,255,255,.03), 0 6px 14px rgba(0,0,0,.25);
    transition:transform .02s ease, background .15s ease;
    font-size:16px;
  }
  .cell:hover{transform:translateY(-1px)}
  .cell.revealed{
    background:linear-gradient(180deg,#141c2b,#0f1720);
    border-color:#243045; cursor:default; box-shadow:none;
  }
  .cell.flag{background:linear-gradient(180deg,#232018,#1b1812); border-color:#4f3a16}
  .cell.mine.revealed{background:linear-gradient(180deg,#30161a,#1b0d10); border-color:#5b1d1d}
  .n1{color:#93c5fd} .n2{color:#86efac} .n3{color:#fda4af} .n4{color:#fbbf24}
  .n5{color:#a78bfa} .n6{color:#67e8f9} .n7{color:#f472b6} .n8{color:#e5e7eb}
  .foot{opacity:.7; font-size:12px; text-align:center; margin-top:6px; color:var(--muted)}
  @media (max-width:768px){
    .toolbar{grid-template-columns: repeat(6,1fr)}
    .row{grid-column: span 3}
    .row.wide{grid-column: span 6}
  }
</style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <h1>è¸©åœ°é›· Minesweeper</h1>
        <span class="chip">é¦–æ“Šä¿åº•ãƒ»é›™æ“Šå±•é–‹ãƒ»é•·æŒ‰æ’æ——</span>
      </div>
      <div class="ctrls">
        <button id="btn-new" class="primary">æ–°å±€ (N)</button>
        <button id="btn-clear" class="">æ¸…é™¤æ——æ¨™</button>
        <button id="btn-retry" class="danger">æŠ•é™é‡ä¾†</button>
      </div>
    </div>

    <div class="toolbar" id="toolbar">
      <div class="group row wide">
        <label>é›£åº¦</label>
        <select id="preset">
          <option value="beginner">åˆç´š 9Ã—9 / 10 é›·</option>
          <option value="intermediate">ä¸­ç´š 16Ã—16 / 40 é›·</option>
          <option value="expert">é«˜ç´š 30Ã—16 / 99 é›·</option>
          <option value="custom">è‡ªè¨‚</option>
        </select>
      </div>
      <div class="group row">
        <label>åˆ— (Rows)</label>
        <input type="number" id="rows" min="5" max="50" value="9">
      </div>
      <div class="group row">
        <label>è¡Œ (Cols)</label>
        <input type="number" id="cols" min="5" max="50" value="9">
      </div>
      <div class="group row">
        <label>åœ°é›·æ•¸</label>
        <input type="number" id="mines" min="1" max="600" value="10">
      </div>
      <div class="group row full">
        <label><input type="checkbox" id="safeArea" checked> é¦–æ“Šæ“´å¼µå®‰å…¨ï¼ˆé¦–æ“Šå‘¨åœä¹Ÿä¸æ”¾é›·ï¼‰</label>
        <label><input type="checkbox" id="chord" checked> å•Ÿç”¨å¿«é€Ÿå±•é–‹ï¼ˆé›™æ“Šæ•¸å­— æˆ– åŒæ™‚å·¦å³éµï¼‰</label>
      </div>
    </div>

    <div class="status">
      <div class="stat">â±ï¸ æ™‚é–“ï¼š<span id="time" class="val">000</span>s</div>
      <div class="stat">ğŸ’£ å‰©é¤˜é›·ï¼š<span id="bombs" class="val">010</span></div>
      <div class="stat">ğŸ“¦ æœªç¿»æ ¼ï¼š<span id="hidden" class="val">081</span></div>
      <div class="stat">ğŸ¯ ç‹€æ…‹ï¼š<span id="state" class="val">ç­‰å¾…é¦–æ“Š</span></div>
    </div>

    <div class="grid-wrap">
      <div id="board" aria-label="Minesweeper board"></div>
    </div>
    <div class="foot">æ“ä½œï¼šå·¦éµç¿»æ ¼ã€å³éµæ’æ——ï¼ˆæ‰‹æ©Ÿé•·æŒ‰ 500ms æ’æ——ï¼‰ã€é›™æ“Šæ•¸å­—/åŒæ™‚å·¦å³éµï¼å¿«é€Ÿå±•é–‹ã€‚</div>
  </div>

<script>
(() => {
  /*** å·¥å…· ***/
  const $ = sel => document.querySelector(sel);
  const fmt3 = n => String(n).padStart(3,'0');
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  /*** ç‹€æ…‹ ***/
  let rows=9, cols=9, mines=10;
  let board=[], firstClick=true, started=false, timer=null, seconds=0;
  let flags=0, hiddenCount=0, alive=true, won=false;
  let safeArea=true, chordEnabled=true;

  const elBoard = $('#board');
  const elTime = $('#time');
  const elBombs = $('#bombs');
  const elHidden = $('#hidden');
  const elState = $('#state');

  /*** åˆå§‹åŒ– ***/
  function setPreset(name){
    if(name==='beginner'){ rows=9; cols=9; mines=10; }
    else if(name==='intermediate'){ rows=16; cols=16; mines=40; }
    else if(name==='expert'){ rows=16; cols=30; mines=99; }
    $('#rows').value = rows; $('#cols').value = cols; $('#mines').value = mines;
  }

  function newGame(){
    // è®€å–UI
    const preset = $('#preset').value;
    if(preset!=='custom') setPreset(preset);
    rows = clamp(parseInt($('#rows').value||9),5,50);
    cols = clamp(parseInt($('#cols').value||9),5,50);
    const maxMines = rows*cols - 1;
    mines = clamp(parseInt($('#mines').value||10), 1, Math.min(600, maxMines));
    safeArea = $('#safeArea').checked;
    chordEnabled = $('#chord').checked;

    // é‡ç½®ç‹€æ…‹
    board = [];
    firstClick = true; started=false; seconds=0; flags=0; alive=true; won=false;
    clearInterval(timer); elTime.textContent=fmt3(seconds);

    // å»ºæ ¼
    elBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    elBoard.innerHTML = '';
    hiddenCount = rows*cols;

    for(let r=0;r<rows;r++){
      const row=[];
      for(let c=0;c<cols;c++){
        row.push({
          r,c,mine:false,adj:0,revealed:false,flag:false,dom:null
        });
      }
      board.push(row);
    }
    // DOM
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const div = document.createElement('button');
        div.className='cell';
        div.setAttribute('data-r',r);
        div.setAttribute('data-c',c);
        div.setAttribute('aria-label','hidden');
        // æ»‘é¼ 
        div.addEventListener('mousedown', onMouseDown);
        div.addEventListener('contextmenu', e=>e.preventDefault());
        div.addEventListener('dblclick', onDblClick);
        // è§¸æ§ï¼ˆé•·æŒ‰æ’æ——ï¼‰
        attachLongPress(div, ()=>toggleFlag(r,c), ()=>reveal(r,c));

        elBoard.appendChild(div);
        board[r][c].dom = div;
      }
    }
    updateHUD('ç­‰å¾…é¦–æ“Š');
    refreshCounts();
  }

  /*** æ›é•·æŒ‰ ***/
  function attachLongPress(el, onLong, onTap){
    let t=null, moved=false;
    el.addEventListener('touchstart', (e)=>{
      moved=false;
      t=setTimeout(()=>{ onLong(); t=null; }, 500);
    }, {passive:true});
    el.addEventListener('touchmove', ()=>{ moved=true; if(t){clearTimeout(t); t=null;} }, {passive:true});
    el.addEventListener('touchend', (e)=>{
      if(t){ clearTimeout(t); t=null; if(!moved) onTap(); }
    });
  }

  /*** äº‹ä»¶ ***/
  function onMouseDown(e){
    if(!alive||won) return;
    const r = +this.dataset.r, c = +this.dataset.c;
    if(e.button===2){ // å³éµ
      e.preventDefault();
      toggleFlag(r,c);
    }else if(e.button===0){ // å·¦éµ
      if(e.buttons===3 && chordEnabled){ // åŒæ™‚å·¦å³éµ
        chord(r,c);
      }else{
        reveal(r,c);
      }
    }
  }
  function onDblClick(e){
    if(!alive||won||!chordEnabled) return;
    const r=+this.dataset.r, c=+this.dataset.c;
    chord(r,c);
  }

  /*** ä½ˆé›·ï¼ˆé¦–æ“Šå¾Œï¼‰ ***/
  function placeMines(excludeSet){
    let placed=0;
    while(placed<mines){
      const idx = (Math.random()*rows*cols)|0;
      const r = (idx/cols)|0, c = idx%cols;
      const key = r+','+c;
      if(excludeSet.has(key)) continue;
      const cell = board[r][c];
      if(!cell.mine){
        cell.mine=true;
        placed++;
      }
    }
    // è¨ˆæ•¸
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        board[r][c].adj = neighbors(r,c).filter(n=>n.mine).length;
      }
    }
  }

  /*** é‚è¼¯ ***/
  function neighbors(r,c){
    const list=[];
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        if(dr===0 && dc===0) continue;
        const nr=r+dr, nc=c+dc;
        if(nr>=0 && nr<rows && nc>=0 && nc<cols) list.push(board[nr][nc]);
      }
    }
    return list;
  }

  function startTimer(){
    if(started) return;
    started=true;
    timer = setInterval(()=>{ seconds++; elTime.textContent=fmt3(seconds); },1000);
  }

  function reveal(r,c){
    const cell = board[r][c];
    if(cell.revealed || cell.flag) return;

    // é¦–æ“Šæ‰ä½ˆé›·ï¼Œä¸¦ç¢ºä¿å®‰å…¨å€
    if(firstClick){
      firstClick=false;
      const exclude = new Set();
      exclude.add(r+','+c);
      if(safeArea){
        neighbors(r,c).forEach(n=>exclude.add(n.r+','+n.c));
      }
      placeMines(exclude);
      startTimer();
    }

    if(cell.mine){
      // è¸©é›·
      lose(cell);
      return;
    }

    floodReveal(r,c);
    checkWin();
  }

  function floodReveal(r,c){
    const q=[[r,c]];
    while(q.length){
      const [rr,cc] = q.shift();
      const cur = board[rr][cc];
      if(cur.revealed || cur.flag) continue;
      cur.revealed=true; hiddenCount--;
      paint(cur);

      if(cur.adj===0){
        neighbors(rr,cc).forEach(n=>{
          if(!n.revealed && !n.flag) q.push([n.r,n.c]);
        });
      }
    }
    refreshCounts();
  }

  function toggleFlag(r,c){
    const cell = board[r][c];
    if(cell.revealed) return;
    cell.flag = !cell.flag;
    flags += cell.flag ? 1 : -1;
    paint(cell);
    refreshCounts();
  }

  function chord(r,c){
    const cell = board[r][c];
    if(!cell.revealed) return;
    const neigh = neighbors(r,c);
    const flagCount = neigh.filter(n=>n.flag).length;
    if(flagCount===cell.adj){
      // å±•é–‹æœªç¿»æœªæ’æ——
      neigh.forEach(n=>{
        if(!n.revealed && !n.flag){
          if(n.mine){ lose(n); }
          else floodReveal(n.r,n.c);
        }
      });
      checkWin();
    }
  }

  function checkWin(){
    if(!alive) return;
    const safeCells = rows*cols - mines;
    const revealed = safeCells - (hiddenCount - mines);
    if(revealed>=safeCells){
      win();
    }
  }

  function win(){
    won=true; alive=false;
    clearInterval(timer);
    elState.textContent='ğŸ‰ å…¨éƒ¨æ¸…é™¤ï¼Œå‹åˆ©ï¼';
    // è‡ªå‹•æ’æ»¿å‰©é¤˜çš„æ——
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      const cell=board[r][c];
      if(cell.mine && !cell.flag){ cell.flag=true; flags++; paint(cell); }
    }
    refreshCounts();
  }

  function lose(triggerCell){
    alive=false; clearInterval(timer);
    elState.textContent='ğŸ’¥ è¸©åˆ°é›·äº†';
    // é¡¯ç¤ºå…¨éƒ¨é›·
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      const cell=board[r][c];
      if(cell.mine){ cell.revealed=true; paint(cell); }
    }
    // æ¨™ç¤ºè§¸ç™¼é›·
    triggerCell.dom.style.outline='2px solid var(--danger)';
  }

  /*** UI ç¹ªè£½ ***/
  function paint(cell){
    const el = cell.dom;
    el.className = 'cell' + (cell.revealed?' revealed':'') + (cell.flag?' flag':'') + (cell.mine?' mine':'');
    if(cell.revealed){
      if(cell.mine){
        el.textContent='ğŸ’£';
        el.setAttribute('aria-label','mine');
      }else{
        el.textContent = cell.adj===0 ? '' : cell.adj;
        el.classList.remove('n1','n2','n3','n4','n5','n6','n7','n8');
        if(cell.adj>0) el.classList.add('n'+cell.adj);
        el.setAttribute('aria-label','revealed '+cell.adj);
      }
    }else{
      el.textContent = cell.flag ? 'ğŸš©' : '';
      el.setAttribute('aria-label', cell.flag?'flag':'hidden');
    }
  }

  function refreshCounts(){
    elBombs.textContent = fmt3(Math.max(mines - flags,0));
    elHidden.textContent = fmt3(hiddenCount);
  }
  function updateHUD(msg){
    elState.textContent = msg || '';
    elTime.textContent = fmt3(seconds);
    elBombs.textContent = fmt3(mines - flags);
    elHidden.textContent = fmt3(hiddenCount);
  }

  /*** æ§åˆ¶é … ***/
  $('#btn-new').addEventListener('click', newGame);
  $('#btn-clear').addEventListener('click', ()=>{
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      const cell=board[r][c];
      if(!cell.revealed && cell.flag){ cell.flag=false; flags--; paint(cell); }
    }
    refreshCounts();
  });
  $('#btn-retry').addEventListener('click', ()=> newGame());
  $('#preset').addEventListener('change', e=>{
    if(e.target.value!=='custom'){ setPreset(e.target.value); }
  });
  // éµç›¤å¿«æ·ï¼šN æ–°å±€ã€R é‡ä¾†
  document.addEventListener('keydown', e=>{
    if(e.key==='N' || e.key==='n') newGame();
    if(e.key==='R' || e.key==='r') newGame();
  });

  // é¦–æ¬¡è¼‰å…¥
  setPreset('beginner');
  newGame();
})();
</script>
</body>
</html>
